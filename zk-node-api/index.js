const express = require('express');
const bodyParser = require('body-parser');
const app = express();
var exec = require('child_process').exec, child;
const fs = require('fs');
var cors = require('cors');

app.use(bodyParser.json());
app.use(cors());

app.get("/createproof", async (req, res, next) => {
    try {
       
        console.log("witnesses: ", req.query.witness)
        
        const wit1 = "sh deploy.sh ";

        // var wit2 = "168904202930327939080492230969004622904 339630068017193623570711849636010664817 1216631698 326532002671535014699329485375999702230 0 0 80710054703952517336223123171789823554 92441430577956810800440641638774416100 3812576291 9221067889684513358870464131861547279 0 0 168904202930327939080492230969004622904 339630068017193623570711849636010664817 0 0";
        // var wit2 = "231534968603483432566977054383346081896 34472804424449765993770596411003645591 1542605201 73865525266444009553374592104126411394 0 0 329150561097534901395758315053534574693 262692223944039126765060305747860309608 2935192993 291622670832145918420358816333041987156 0 0 231534968603483432566977054383346081896 34472804424449765993770596411003645591 0 0";
        // var wit2 ="80710054703952517336223123171789823554 92441430577956810800440641638774416100 3812576291 9221067889684513358870464131861547279 0 0 168904202930327939080492230969004622904 339630068017193623570711849636010664817 1216631698 326532002671535014699329485375999702230 0 0 80710054703952517336223123171789823554 92441430577956810800440641638774416100 0 0";
        // var wit2 = "80710054703952517336223123171789823554 92441430577956810800440641638774416100 3812576291 9221067889684513358870464131861547279 0 0 329150561097534901395758315053534574693 262692223944039126765060305747860309608 2935192993 291622670832145918420358816333041987156 0 0 80710054703952517336223123171789823554 92441430577956810800440641638774416100 0 0";
        
        const  wit3 = wit1 + '"' + req.query.witness + '"';
        // const wit3 = wit1 + '"' + wit2 + '"';
        console.log(wit3)

        if(req.query.witness != undefined) {
            child = await exec(wit3, {maxBuffer: 1024 * 500* 1000} ,
            // child = await exec('sh deploy.sh "231534968603483432566977054383346081896 34472804424449765993770596411003645591 1542605201 73865525266444009553374592104126411394 0 0 329150561097534901395758315053534574693 262692223944039126765060305747860309608 2935192993 291622670832145918420358816333041987156 0 0 231534968603483432566977054383346081896 34472804424449765993770596411003645591 0 0"',
            function (error, stdout, stderr) {
                // res.send("Done")
                // console.log('stdout: ' + stdout);
                // console.log('stderr: ' + stderr);
                var obj;
                fs.readFile('zk-container_proof.json', 'utf8', function (err, data) {
                    if (err) throw err;
                    obj = JSON.parse(data);
                    console.log(obj);
                    res.send(obj)
                });
                if (error !== null) {
                    console.log('exec error: ' + error);
                }
            });        
        } else {
            res.send("Witness is not given in params");
        }

    } catch (error) {
        console.log("Createproof error: ", error)
    }
});

app.get("/getProof", (req, res, next) => {
    var obj;
    fs.readFile('zk-container_proof.json', 'utf8', function (err, data) {
    if (err) throw err;
    obj = JSON.parse(data);
    res.send(obj)
    });
});


app.listen(3001, () => {
 console.log("Server running on port 3001");
});
